<!DOCTYPE html>
<!-- tutorials/documentary:
https://code.tutsplus.com/tutorials/introduction-to-web-midi--cms-25220
https://code.tutsplus.com/series/the-web-audio-api--cms-817
https://webaudio.github.io/web-midi-api/#conformance 
https://www.npmjs.com/package/soundfont-player 
https://github.com/gleitz/midi-js-soundfonts
https://github.com/mudcube/MIDI.js
https://github.com/Theodeus/tuna
-->

<!-- 
aspects of the music:
-let user select key
-RGB ave value (r + g + b) / 3 but put into better range : pitch
- dominating rgb value = pitch
- three different instruments for pitch, each from rgb (play a chord)
-RGB percentage within 255 range, ((r + g + b) / (255*3)) * 1500, where 1500 is max number of ms that I want : duration
-size of image/size of pixel group: duration?
-duration: based on one of rgb, user gets to choose which one
-RED: ?
-GREEN: ?
-BLUE: ?
-APLHA: key?
-LUM: effects and also major/minor key (if in lower half then minor, else major) 
-->

<html>

<head>

	<title>Senior Design: Image Vocalization</title>
	<link rel="stylesheet" href="style.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<link rel="stylesheet" href="dropzone.css"/>
	<script src="dropzone.js"></script>
	
	<script src="soundfont-player.min.js"></script>
	<script src="imageToMelody.js"></script>
	<script src="MIDI.js/build/MIDI.min.js"></script>
	
	<script src="MIDI.js/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="MIDI.js/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="MIDI.js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="MIDI.js/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/gm.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/loader.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="MIDI.js/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="MIDI.js/js/util/dom_request_script.js" type="text/javascript"></script>
	
	<script src="tuna/tuna-min.js"></script>

	<script>
		var audioContext = new AudioContext();
		var schedule;
		var img;
		var canvas;
		var imgContext;

		/* These arrays contain the required mod results to be in the specified major key.
		   For example, if the note % 12 == 0, then it's the note C. 
		   If the note % 12 == 1, then it's the note C#/Db */
		   
		// [C, D, E, F, G, A, B]
		var keyOfC = [0, 2, 4, 5, 7, 9, 11];

		// [G, A, B, C, D, E, F#]
		var keyOfG = [7, 9, 11, 0, 2, 4, 6];

		// [D, E, F#, G, A, B, C#]
		var keyOfD = [2, 4, 6, 7, 9, 11, 1];

		// [A, B, C#, D, E, F#, G#]
		var keyOfA = [9, 11, 1, 2, 4, 6, 8];

		function readURL(input) {
		    if (input.files && input.files[0]) {

		        var reader = new FileReader();
		        reader.onload = function (e) {
		            $('#user-img').attr('src', e.target.result);
		        }
		        reader.readAsDataURL(input.files[0]);
		    }
		}

		function play() {
			img = document.getElementById('user-img');
			if(img.getAttribute('src') == '#') {
				alert("Please upload an image before playing.");
				return;
			}
			var sweep;
			if (document.getElementById('left-to-right').checked) {
				sweep = 'left-to-right';
			} else if (document.getElementById('other').checked) {
				sweep = 'other';
			} else {
				alert("Please select a sweeping pattern before playing.");
				return;
			}

			canvas = document.createElement('canvas');
			imgContext = canvas.getContext('2d');
			canvas.width = img.width;
			canvas.height = img.height;
			imgContext.drawImage(img, 0, 0);
			var pixelGroups = getImgData(img, sweep, imgContext);
			//var luminosity = getLuminosity(imgContext, img);
			playSong(pixelGroups);
		}

		function getImgData(img, sweep, imgContext) {
			//set x, y, width, and height here based on what sweeping pattern is used
			var reqs = getSweepRequirements(img, sweep);
			var pixelGroups = [];

			//get averages for each chunk of pixels, and store in array
			while (reqs.x < img.width) {
				var averages = getRGBAverages(reqs, imgContext);
				pixelGroups.push({
					red: averages.red,
					green: averages.green,
					blue: averages.blue,
					alpha: averages.alpha
				});

				//set new x, y, width, and height here. This will also differ depending
				//on the sweeping pattern
				reqs = updateSweepRequirements(img, sweep, reqs);
			}

			return pixelGroups;
		}

		// function getLuminosity(imgContext, img) {
		// 	var reqs = getSweepRequirements(img, 'entire');
		// 	averages = getRGBAverages(reqs, imgContext);
		// 	return (0.2126*averages.red + 0.7152*averages.green + 0.0722*averages.blue);
		// }

		function getRGBAverages(reqs, imgContext) {
			var imageData = imgContext.getImageData(reqs.x, reqs.y, reqs.width, reqs.height);
			var pixelData = imageData.data;
			var numPixels = pixelData.length / 4;
			var redSum = greenSum = blueSum = alphaSum = 0;
			var redAverage = greenAverage = blueAverage = alphaAverage = 0;

			for (i = 0; i < pixelData.length; i++) {
				if (i % 4 == 0) { //red
					redSum += pixelData[i];
				} else if (i % 4 == 1) { //green
					greenSum += pixelData[i];
				} else if (i % 4 == 2) { //blue
					blueSum += pixelData[i];
				} else if (i % 4 == 3) { //alpha
					alphaSum += pixelData[i];
				}
			}
			redAverage = redSum / numPixels;
			greenAverage = greenSum / numPixels;
			blueAverage = blueSum / numPixels;
			alphaAverage = alphaSum / numPixels;

			return {
				red: redAverage,
				green: greenAverage,
				blue: blueAverage,
				alpha: alphaAverage
			};
		}

		function getSweepRequirements(img, sweep) {
			switch(sweep) {
				case 'left-to-right':
					return {
						x: 0,
						y: 0,
						width: img.width / 25,
						height: img.height
					};
			}
		}

		function updateSweepRequirements(img, sweep, currentReqs) {
			if (sweep == 'left-to-right') {
				return {
					x: currentReqs.x += currentReqs.width,
					y: 0,
					width: img.width / 25,
					height: img.height
				};
			}
		}
 
		function playSong(pixelGroups) {
			// console.log(luminosity);
			// schedule = [];
			// var clock = 0;
			
			// for (var i = 0; i < pixelGroups.length; i++) {
			// 	var frequency = Math.floor(pixelGroups[i].red % 88) + 21;
			// 	var noteLength = getNoteLength(pixelGroups[i].green);
			// 	schedule.push({
			// 		time: clock,
			// 		note: frequency
			// 	});
			// 	clock += noteLength;
			// }

 		// 	Soundfont.instrument(audioContext, 'acoustic_grand_piano', {attack: 0}).then(function (piano) {
  	// 			piano.schedule(audioContext.currentTime, schedule)
			// });

			notesData = [];
			
			for (var i = 0; i < pixelGroups.length; i++) {
				var redNote = getPitchInKey(pixelGroups[i].red);
				var greenNote = getPitchInKey(pixelGroups[i].green);
				var blueNote = getPitchInKey(pixelGroups[i].blue);
				var duration = getNoteLength(pixelGroups[i].green);
				var luminosity = 0.2126*pixelGroups[i].red + 0.7152*pixelGroups[i].green + 0.0722*pixelGroups[i].blue;

				notesData.push({
					redNote: redNote,
					greenNote: greenNote,
					blueNote: blueNote,
					duration: duration,
					lum: luminosity
				});
			}

			for (var i = 0; i < notesData.length; i++) {
				console.log("redNote: " + notesData[i].redNote);
				console.log("greenNote: " + notesData[i].greenNote);
				console.log("blueNote: " + notesData[i].blueNote);
				//console.log("duration: " + notesData[i].duration);
				console.log("");
			}			

			MIDI.loadPlugin({
			    soundfontUrl: "http://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/",
			    instrument: "acoustic_grand_piano",
			    onsuccess: function() {
			    	playNotes(0, notesData);
			    }
			});
		}

		function getPitchInKey(rgbVal) {
			//plays notes in the midi note range 21 - 108 (inclusive)
			var note = Math.floor(rgbVal % 88) + 21;
			var scaleDegree = note % 12;
			var keyArray = window[document.querySelector('input[name="keys"]:checked').id];
			note = getNoteInSpecifiedKey(keyArray, scaleDegree, note);

			return note;
		}

		function getNoteInSpecifiedKey(keyArray, scaleDegree, note) {
		    for (var i = 0; i < keyArray.length; i++) {
		    	if (scaleDegree == keyArray[i]) {  // it's in the key, so it's all good
		    		return note;
		    	}
		    }
		    // it's not, so add 1 and try again
		    return getNoteInSpecifiedKey(keyArray, scaleDegree + 1, note + 1);
		}

		function playNotes(i, notesData) {
			if (i < notesData.length) {
				setFilters(notesData[i].lum);

		        var delay = 0; 
		        var velocity = 127; 
		        MIDI.setVolume(0, 127);
		        MIDI.noteOn(0, notesData[i].redNote, velocity, delay);
		        MIDI.noteOn(0, notesData[i].greenNote, velocity, delay);
		        MIDI.noteOn(0, notesData[i].blueNote, velocity, delay);
		        sleep(notesData[i].duration).then(() => {
		        	MIDI.noteOff(0, notesData[i].redNote, delay + notesData[i].duration);
		        	MIDI.noteOff(0, notesData[i].greenNote, delay + notesData[i].duration);
		        	MIDI.noteOff(0, notesData[i].blueNote, delay + notesData[i].duration);
		        	playNotes(i+1, notesData);
		        });
			}
		}

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

		function setFilters(lum) {
			excursion = lum / 42.5; // highest lum is 255, and 255 split into 6 groups is 42.5 per group
			baseFreq = lum / 127.5; // highest lum is 255, and 255 split into 2 groups is 127.5 per group
			intensity = lum / 127.5; // highest lum is 255, and 255 split into 2 groups is 127.5 per group
			rate = lum / 31.875 // highest lum is 255, and 255 split into 8 groups is 31.875 per group
			
			MIDI.setEffects([{
					type: "WahWah",
			        automode: true, // true/false
			        baseFrequency: baseFreq, // 0 to 1
			        excursionOctaves: excursion, // 1 to 6
			        sweep: 0, // 0 to 1
			        resonance: 1, // 1 to 100
			        sensitivity: 0, // -1 to 1
			        bypass: 0
			      
			        // type: "Tremolo",
			        // intensity: intensity, // 0 to 1
			        // rate: rate, // 0.001 to 8
			        // stereoPhase: 0, // 0 to 180
			        // bypass: 0

					// type: "Filter",
			  //       frequency: 2500, // 20 to 22050
			  //       Q: 1, // 0.001 to 100
			  //       gain: 0, // -40 to 40
			  //       bypass: 0, // 0 to 1+
			  //       filterType: "highpass" // 0 to 7, corresponds to the filter types in the native filter node: lowpass, highpass, bandpass, lowshelf, highshelf, peaking, notch, allpass in that order
			    }
			]);
		}

		function getNoteLength(greenAverage) {
			return (greenAverage % 1.2) * 1000;
		}

	</script>

</head>

<body class="background-pic">
	<div class="image-vocal">
		<h1>Senior Design: Image Vocalization</h1>
		<hr>
    	<input type="file" id="image-input" onchange="readURL(this);"/> <br>
    	<img id="user-img" src="#" alt="your uploaded image"/> <br>
 	   	<button id="midi-btn" onclick="getMidi()">Get Midi Access</button>
 	   	Left to Right: <input type="radio" id="left-to-right">
 	   	Other: <input type="radio" id="other">
 	   	<button id="play-btn" onclick="play()">Play</button>
	 	<hr>
	 	<p> Choose a key to play in: </p>
	 	C: <input type="radio" id="keyOfC" name="keys">
	 	G: <input type="radio" id="keyOfG" name="keys">
	 	D: <input type="radio" id="keyOfD" name="keys">
	 	A: <input type="radio" id="keyOfA" name="keys">

	</div>
</body>
</html>
