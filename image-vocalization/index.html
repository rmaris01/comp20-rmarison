<!DOCTYPE html>
<!-- tutorials/documentary:
https://code.tutsplus.com/tutorials/introduction-to-web-midi--cms-25220
https://code.tutsplus.com/series/the-web-audio-api--cms-817
https://webaudio.github.io/web-midi-api/#conformance -->

<!-- soundfonts:
http://soundfonts.gonet.biz/search.php?goto=1&grupo=1 -->

<html>

<head>

	<title>Senior Design: Image Vocalization</title>
	<link rel="stylesheet" href="style.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<link rel="stylesheet" href="dropzone.css"/>
	<script src="dropzone.js"></script>
	
	<script src="soundfont-player.min.js"></script>
	<script src="imageToMelody.js"></script>

	<script>
		var audioContext = new AudioContext();
		var schedule;
		var img;
		var canvas;
		var imgContext;

		function readURL(input) {
		    if (input.files && input.files[0]) {

		        var reader = new FileReader();
		        reader.onload = function (e) {
		            $('#user-img').attr('src', e.target.result);
		        }
		        reader.readAsDataURL(input.files[0]);
		    }
		}

		function play() {
			img = document.getElementById('user-img');
			if(img.getAttribute('src') == '#') {
				alert("Please upload an image before playing.");
				return;
			}
			var sweep;
			if (document.getElementById('left-to-right').checked) {
				sweep = 'left-to-right';
			} else if (document.getElementById('other').checked) {
				sweep = 'other';
			} else {
				alert("Please select a sweeping pattern before playing.");
				return;
			}
			var pixelGroups = getImgData(img, sweep);
			playNotes(pixelGroups);
		}

		function getImgData(img, sweep) {
			canvas = document.createElement('canvas');
			imgContext = canvas.getContext('2d');
			canvas.width = img.width;
			canvas.height = img.height;
			imgContext.drawImage(img, 0, 0);
			var pixelGroups = [];

			//set x, y, width, and height here based on what sweeping pattern is used
			var reqs = getSweepRequirements(img, sweep);

			//get averages for each chunk of pixels, and store in array
			while (reqs.x < img.width) {
				var imageData = imgContext.getImageData(reqs.x, reqs.y, reqs.width, reqs.height);
				var pixelData = imageData.data;
				var numPixels = pixelData.length / 4;
				var redSum = greenSum = blueSum = alphaSum = 0;
				var redAverage = greenAverage = blueAverage = alphaAverage = 0;

				for (i = 0; i < pixelData.length; i++) {
					if (i % 4 == 0) { //red
						redSum += pixelData[i];
					} else if (i % 4 == 1) { //green
						greenSum += pixelData[i];
					} else if (i % 4 == 2) { //blue
						blueSum += pixelData[i];
					} else if (i % 4 == 3) { //alpha
						alphaSum += pixelData[i];
					}
				}
				redAverage = redSum / numPixels;
				greenAverage = greenSum / numPixels;
				blueAverage = blueSum / numPixels;
				alphaAverage = alphaSum / numPixels;

				pixelGroups.push({
					red: redAverage,
					green: greenAverage,
					blue: blueAverage,
					alpha: alphaAverage
				});

				//set new x, y, width, and height here. This will also differ depending
				//on the sweeping pattern
				reqs = updateSweepRequirements(img, sweep, reqs);
			}
			return pixelGroups;
		}

		function getSweepRequirements(img, sweep) {
			if (sweep == 'left-to-right') {
				return {
					x: 0,
					y: 0,
					width: img.width / 25,
					height: img.height
				};
			}
		}

		function updateSweepRequirements(img, sweep, currentReqs) {
			if (sweep == 'left-to-right') {
				return {
					x: currentReqs.x += currentReqs.width,
					y: 0,
					width: img.width / 25,
					height: img.height
				};
			}
		}
 
		function playNotes(pixelGroups) {
			schedule = [];
			var clock = 0;
			for (var i = 0; i < pixelGroups.length; i++) {
				var frequency = Math.floor(pixelGroups[i].red % 88) + 21;
				var noteLength = getNoteLength(pixelGroups[i].green);
				schedule.push({
					time: clock,
					note: frequency
				});
				clock += noteLength;
			}

			for (var i = 0; i < schedule.length; i++) {
				console.log("time: " + schedule[i].time + "note: " + schedule[i].note);
			}			

 			//plays notes in the midi note range 21 - 108 (inclusive)
 			Soundfont.instrument(audioContext, 'acoustic_grand_piano').then(function (piano) {
  				piano.schedule(audioContext.currentTime, schedule)
			});
			
		}

		function getNoteLength(greenAverage) {
			return (greenAverage % 2) + 1;
		}

	</script>

</head>

<body class="background-pic">
	<div class="image-vocal">
		<h1>Senior Design: Image Vocalization</h1>
		<hr>
    	<input type="file" id="image-input" onchange="readURL(this);"/> <br>
    	<img id="user-img" src="#" alt="your uploaded image"/> <br>
 	   	<button id="midi-btn" onclick="getMidi()">Get Midi Access</button>
 	   	Left to Right: <input type="radio" id="left-to-right">
 	   	Other: <input type="radio" id="other">
 	   	<button id="play-btn" onclick="play()">Play</button>
	 	<!-- <button id="img-data-btn" onclick="getImgData()">Get Image Data</button>
	 	<button id="play-notes-btn" onclick="playNotes()">Play</button> -->
	 	<!-- <button id="stop-btn" onclick="stop()">Stop</button> -->
	</div>
</body>
</html>
