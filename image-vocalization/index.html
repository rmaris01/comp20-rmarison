<!DOCTYPE html>
<!-- tutorials/documentary:
https://code.tutsplus.com/tutorials/introduction-to-web-midi--cms-25220
https://code.tutsplus.com/series/the-web-audio-api--cms-817
https://webaudio.github.io/web-midi-api/#conformance -->

<!-- soundfonts:
http://soundfonts.gonet.biz/search.php?goto=1&grupo=1 -->

<html>

<head>

	<title>Senior Design: Image Vocalization</title>
	<link rel="stylesheet" href="style.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<link rel="stylesheet" href="dropzone.css"/>
	<script src="dropzone.js"></script>
	
	<script src="soundfont-player.min.js"></script>

	<script>
		var context = new AudioContext();
    	var oscillator;
		var midi = null;  // global MIDIAccess object
		var midiData = null;
		var redAverage = 0;
		var greenAverage = 0;
		var blueAverage = 0;
		var alphaAverage = 0;

		function readURL(input) {
		    if (input.files && input.files[0]) {

		        var reader = new FileReader();
		        reader.onload = function (e) {
		            $('#user-img').attr('src', e.target.result);
		        }
		        reader.readAsDataURL(input.files[0]);
		    }
		}

		function onMIDIMessage (message) {
			midiData = message.data;
    		console.log("MIDI data", midiData);
		}

		function onMIDISuccess( midiAccess ) {
			console.log( "MIDI ready!" );
			midi = midiAccess;  // store in the global (in real usage, would probably keep in an object instance)
			console.log(midi);
			var inputs = midi.inputs.values();
			for (var input = inputs.next(); input && !input.done; input = inputs.next()) {
    			console.log('in loop');
    			// each time there is a midi message call the onMIDIMessage function
    			input.value.onmidimessage = onMIDIMessage;
    			var input = input.value;
			    console.log("Input port : [ type:'" + input.type + "' id: '" + input.id +
			        "' manufacturer: '" + input.manufacturer + "' name: '" + input.name +
			        "' version: '" + input.version + "']");	
			}
		}

		function onMIDIFailure(msg) {
			console.log( "Failed to get MIDI access - " + msg );
		}

		function getMidi() {
			// navigator.requestMIDIAccess().then( onMIDISuccess, onMIDIFailure );
			if (navigator.requestMIDIAccess) {
			    navigator.requestMIDIAccess({
			        sysex: false
			    }).then(onMIDISuccess, onMIDIFailure);
			} else {
			    alert("No MIDI support in your browser.");
			}
		}

		function getImgData() {
			var img = document.getElementById('user-img');
			var canvas = document.createElement('canvas');
			var context = canvas.getContext('2d');
			canvas.width = img.width;
			canvas.height = img.height;
			context.drawImage(img, 0, 0);
			var imageData = context.getImageData(0, 0, img.width, img.height);
			var pixelData = imageData.data;
			var numPixels = pixelData.length / 4;
			var redSum = 0;
			var greenSum = 0;
			var blueSum = 0;
			var alphaSum = 0;

			for (i = 0; i < pixelData.length; i++) {
				if (i % 4 == 0) { //red
					redSum += pixelData[i];
				} else if (i % 4 == 1) { //green
					greenSum += pixelData[i];
				} else if (i % 4 == 2) { //blue
					blueSum += pixelData[i];
				} else if (i % 4 == 3) { //alpha
					alphaSum += pixelData[i];
				}
			}

			redAverage = redSum / numPixels;
			greenAverage = greenSum / numPixels;
			blueAverage = blueSum / numPixels;
			alphaAverage = alphaSum / numPixels;

			console.log("red ave: " + redAverage + "\n");
			console.log("green ave: " + greenAverage + "\n");
			console.log("blue ave: " + blueAverage + "\n");
			console.log("alpha ave: " + alphaAverage + "\n");
		}

		function playNote (frequency, noteLength) {
			//start playing the note
		    oscillator = context.createOscillator();
		    oscillator.frequency.value = frequency;
		    oscillator.connect(context.destination);
		    oscillator.start(context.currentTime);

		    //stop playing the note after some length of time
		    oscillator.stop(context.currentTime + noteLength);
		    //oscillator.disconnect();
		}
 
		// function stopNote (frequency) {
		//     oscillators[frequency].stop(context.currentTime);
		//     oscillators[frequency].disconnect();
		// }

		function play() {
			var frequency = Math.floor(redAverage % 88) + 21;
			console.log(redAverage);
			var noteLength = getNoteLength(greenAverage);
			//playNote(redAverage, noteLength);
 			//stopNote(redAverage);

 			// plays notes in the midi note range 21 - 108 (inclusive)
 			Soundfont.instrument(context, 'acoustic_grand_piano').then(function (piano) {
  				piano.play(frequency, context.currentTime, { duration: noteLength})
			});
		}

		function getNoteLength(greenAverage) {
			return (greenAverage % 5) + 1;
		}

		// function stop() {
		// 	console.log(redAverage);
		// 	stopNote(redAverage);
		// }

	</script>

</head>

<body class="background-pic">
	<div class="image-vocal">
		<h1>Senior Design: Image Vocalization</h1>
		<hr>
    	<input type="file" id="image-input" onchange="readURL(this);"/> <br>
    	<img id="user-img" src="#" alt="your uploaded image"/> <br>
 	   	<button id="midi-btn" onclick="getMidi()">Get Midi Access</button>
	 	<button id="img-data-btn" onclick="getImgData()">Get Image Data</button>
	 	<button id="play-btn" onclick="play()">Play</button>
	 	<!-- <button id="stop-btn" onclick="stop()">Stop</button> -->
	</div>
</body>
</html>
