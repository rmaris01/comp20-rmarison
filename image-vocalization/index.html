<!DOCTYPE html>
<!-- tutorials/documentary:
https://code.tutsplus.com/tutorials/introduction-to-web-midi--cms-25220
https://code.tutsplus.com/series/the-web-audio-api--cms-817
https://webaudio.github.io/web-midi-api/#conformance 
https://www.npmjs.com/package/soundfont-player -->

<!-- soundfonts:
http://soundfonts.gonet.biz/search.php?goto=1&grupo=1 -->

<html>

<head>

	<title>Senior Design: Image Vocalization</title>
	<link rel="stylesheet" href="style.css"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<link rel="stylesheet" href="dropzone.css"/>
	<script src="dropzone.js"></script>
	
	<script src="soundfont-player.min.js"></script>
	<script src="imageToMelody.js"></script>
	<script src="MIDI.js/build/MIDI.min.js"></script>
	
	<script src="MIDI.js/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="MIDI.js/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="MIDI.js/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="MIDI.js/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/gm.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/loader.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="MIDI.js/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="MIDI.js/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="MIDI.js/js/util/dom_request_script.js" type="text/javascript"></script>
	
	<script src="tuna/tuna-min.js"></script>




	<script>
		var audioContext = new AudioContext();
		var schedule;
		var img;
		var canvas;
		var imgContext;


		function readURL(input) {
		    if (input.files && input.files[0]) {

		        var reader = new FileReader();
		        reader.onload = function (e) {
		            $('#user-img').attr('src', e.target.result);
		        }
		        reader.readAsDataURL(input.files[0]);
		    }
		}

		function play() {
			img = document.getElementById('user-img');
			if(img.getAttribute('src') == '#') {
				alert("Please upload an image before playing.");
				return;
			}
			var sweep;
			if (document.getElementById('left-to-right').checked) {
				sweep = 'left-to-right';
			} else if (document.getElementById('other').checked) {
				sweep = 'other';
			} else {
				alert("Please select a sweeping pattern before playing.");
				return;
			}

			canvas = document.createElement('canvas');
			imgContext = canvas.getContext('2d');
			canvas.width = img.width;
			canvas.height = img.height;
			imgContext.drawImage(img, 0, 0);
			var pixelGroups = getImgData(img, sweep, imgContext);
			var luminosity = getLuminosity(imgContext, img);
			playNotes(pixelGroups, luminosity);
		}

		function getImgData(img, sweep, imgContext) {
			//set x, y, width, and height here based on what sweeping pattern is used
			var reqs = getSweepRequirements(img, sweep);
			var pixelGroups = [];

			//get averages for each chunk of pixels, and store in array
			while (reqs.x < img.width) {
				var averages = getRGBAverages(reqs, imgContext);
				pixelGroups.push({
					red: averages.red,
					green: averages.green,
					blue: averages.blue,
					alpha: averages.alpha
				});

				//set new x, y, width, and height here. This will also differ depending
				//on the sweeping pattern
				reqs = updateSweepRequirements(img, sweep, reqs);
			}

			return pixelGroups;
		}

		function getLuminosity(imgContext, img) {
			var reqs = getSweepRequirements(img, 'entire');
			averages = getRGBAverages(reqs, imgContext);
			return (0.2126*averages.red + 0.7152*averages.green + 0.0722*averages.blue);
		}

		function getRGBAverages(reqs, imgContext) {
			var imageData = imgContext.getImageData(reqs.x, reqs.y, reqs.width, reqs.height);
			var pixelData = imageData.data;
			var numPixels = pixelData.length / 4;
			var redSum = greenSum = blueSum = alphaSum = 0;
			var redAverage = greenAverage = blueAverage = alphaAverage = 0;

			for (i = 0; i < pixelData.length; i++) {
				if (i % 4 == 0) { //red
					redSum += pixelData[i];
				} else if (i % 4 == 1) { //green
					greenSum += pixelData[i];
				} else if (i % 4 == 2) { //blue
					blueSum += pixelData[i];
				} else if (i % 4 == 3) { //alpha
					alphaSum += pixelData[i];
				}
			}
			redAverage = redSum / numPixels;
			greenAverage = greenSum / numPixels;
			blueAverage = blueSum / numPixels;
			alphaAverage = alphaSum / numPixels;

			return {
				red: redAverage,
				green: greenAverage,
				blue: blueAverage,
				alpha: alphaAverage
			};
		}

		function getSweepRequirements(img, sweep) {
			switch(sweep) {
				case 'left-to-right':
					return {
						x: 0,
						y: 0,
						width: img.width / 25,
						height: img.height
					};
				case 'entire':
					return {
						x: 0,
						y: 0,
						width: img.width,
						height: img.height
					};
			}
		}

		function updateSweepRequirements(img, sweep, currentReqs) {
			if (sweep == 'left-to-right') {
				return {
					x: currentReqs.x += currentReqs.width,
					y: 0,
					width: img.width / 25,
					height: img.height
				};
			}
		}
 
		function playNotes(pixelGroups, luminosity) {
			console.log(luminosity);
			// schedule = [];
			// var clock = 0;
			
			// for (var i = 0; i < pixelGroups.length; i++) {
			// 	var frequency = Math.floor(pixelGroups[i].red % 88) + 21;
			// 	var noteLength = getNoteLength(pixelGroups[i].green);
			// 	schedule.push({
			// 		time: clock,
			// 		note: frequency
			// 	});
			// 	clock += noteLength;
			// }

			notesAndDurations = [];
			
			for (var i = 0; i < pixelGroups.length; i++) {
				var frequency = Math.floor(pixelGroups[i].red % 88) + 21;
				var duration = getNoteLength(pixelGroups[i].green);
				notesAndDurations.push({
					duration: duration,
					note: frequency
				});
			}

			for (var i = 0; i < notesAndDurations.length; i++) {
				console.log("note: " + notesAndDurations[i].note);
			}			

 		// 	//plays notes in the midi note range 21 - 108 (inclusive)
 		// 	Soundfont.instrument(audioContext, 'acoustic_grand_piano', {attack: 0}).then(function (piano) {
  	// 			piano.schedule(audioContext.currentTime, schedule)
			// });

			MIDI.loadPlugin({
			    soundfontUrl: "http://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/",
			    instrument: "acoustic_grand_piano",
			    onsuccess: function() {
			    	filter()
			    	playNote(0, notesAndDurations);
			    	
			   //  		var frequency = Math.floor(pixelGroups[i].red % 88) + 21;
						// var noteLength = getNoteLength(pixelGroups[i].green);
				  //       var delay = 0; // play one note every quarter second
				  //       var velocity = 127; // how hard the note hits
				  //       // play the note
				  //       MIDI.setVolume(0, 127);

				  //       filter()
				  //       MIDI.noteOn(0, frequency, velocity, delay);
				  //       sleep(750).then(() => {
				  //       	MIDI.noteOff(0, frequency, delay + 0.75);
				  //       	play_note();
				  //       });
			    	
			    }
			});
		}

		function playNote(i, notesAndDurations) {
			if (i < notesAndDurations.length) {
				// var frequency = Math.floor(pixelGroups[i].red % 88) + 21;
				// var noteLength = getNoteLength(pixelGroups[i].green);
		        var delay = 0; // play one note every quarter second
		        var velocity = 127; // how hard the note hits
		        // play the note
		        MIDI.setVolume(0, 127);

		        MIDI.noteOn(0, notesAndDurations[i].note, velocity, delay);
		        sleep(notesAndDurations[i].duration).then(() => {
		        	MIDI.noteOff(0, notesAndDurations[i].note, delay + notesAndDurations[i].duration);
		        	playNote(i+1, notesAndDurations);
		        });
			}
		}

		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}


		function filter() {
			MIDI.setEffects([{
				type: "WahWah",
		        automode: true, // true/false
		        baseFrequency: 0.5, // 0 to 1
		        excursionOctaves: 2, // 1 to 6
		        sweep: 0.2, // 0 to 1
		        resonance: 10, // 1 to 100
		        sensitivity: 0.5, // -1 to 1
		        bypass: 0
					// type: "Filter",
			  //       frequency: 2500, // 20 to 22050
			  //       Q: 1, // 0.001 to 100
			  //       gain: 0, // -40 to 40
			  //       bypass: 0, // 0 to 1+
			  //       filterType: "highpass" // 0 to 7, corresponds to the filter types in the native filter node: lowpass, highpass, bandpass, lowshelf, highshelf, peaking, notch, allpass in that order
			    }
			]);
		}

		function getNoteLength(greenAverage) {
			return (greenAverage % 1.2) * 1000;
		}

	</script>

</head>

<body class="background-pic">
	<div class="image-vocal">
		<h1>Senior Design: Image Vocalization</h1>
		<hr>
    	<input type="file" id="image-input" onchange="readURL(this);"/> <br>
    	<img id="user-img" src="#" alt="your uploaded image"/> <br>
 	   	<button id="midi-btn" onclick="getMidi()">Get Midi Access</button>
 	   	Left to Right: <input type="radio" id="left-to-right">
 	   	Other: <input type="radio" id="other">
 	   	<button id="play-btn" onclick="play()">Play</button>
	 	<!-- <button id="img-data-btn" onclick="getImgData()">Get Image Data</button>
	 	<button id="play-notes-btn" onclick="playNotes()">Play</button> -->
	 	<!-- <button id="stop-btn" onclick="stop()">Stop</button> -->
	</div>
</body>
</html>
