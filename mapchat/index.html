<!DOCTYPE html>

<html>
	<head>
		<title>Map Chat</title>
 		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
 		<link rel="stylesheet" href="style.css"/>

 		<script>
 			var myLat = 0;
 			var myLong = 0;
 			var xhr;
 			var jsonData; 
 			var parsedData;			
 			var myLocation;
 			var options = {
 				zoom: 13, center: myLocation, mapTypeId: google.maps.MapTypeId.ROADMAP
 			};
 			var map;

 			function init() {
 				map = new google.maps.Map(document.getElementById("map_canvas"), options);
 				xhr = new XMLHttpRequest();
 				getMyLocation();

 				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4 && xhr.status == 200) {
						jsonData = xhr.responseText;
						parsedData = JSON.parse(jsonData);
						createMap();
					}
				};
 			}

 			function getMyLocation() {
 				if (navigator.geolocation) { // the navigator.geolocation object is supported on browser
					navigator.geolocation.getCurrentPosition(function(pos) {
						myLat = pos.coords.latitude;
						myLong = pos.coords.longitude;

						xhr.open("POST", "https://secret-about-box.herokuapp.com/sendLocation", true);
 						xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
 						xhr.send("login=ErinHair&lat=" + myLat + "&lng=" + myLong + "&message=Location");
					});
				}
				else {
					alert("Geolocation is not supported by your web browser.");
				}
 			}

 			function createMap() {
 				for (var i = 0; i < parsedData.length; i++) {
 					setMarker(parsedData[i]);
 				}

 				myLocation = new google.maps.LatLng(myLat, myLong);

 				//Update map: this will display the actual map and pan to my location
 				map.panTo(myLocation);
 			}

 			function setMarker(markerData) {
 				var infoWindow = new google.maps.InfoWindow();
 				var markerLocation = new google.maps.LatLng(markerData["lat"], markerData["lng"]);
 				var currentMarker = new google.maps.Marker ({
 					position: markerLocation, title: markerData["login"]
 				})
 				currentMarker.setMap(map);

 				google.maps.event.addListener(currentMarker, 'click', function() {
 					infoWindow.setContent(currentMarker.title);
 					infoWindow.open(map, currentMarker);
 				});
 			}

 		</script>

	</head>
	
	<body onload="init()">
		<div id="map_canvas"></div>
	</body>

</html>